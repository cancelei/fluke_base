<!DOCTYPE html>
<html>
<head>
    <title>Stealth Mode Test</title>
    <script src="https://unpkg.com/@hotwired/stimulus/dist/stimulus.umd.js"></script>
    <style>
        .hidden { display: none !important; }
        button { padding: 8px 16px; margin: 8px; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2563EB; }
        .container { padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stealth Mode Test</h1>

        <!-- Stimulus Controller Wrapper -->
        <div data-controller="stealth-mode" data-stealth-mode-edit-mode-value="true">

            <!-- Stealth Mode Section -->
            <div id="stealth-mode-section" data-stealth-mode-target="section" class="section">
                <h2>Stealth Mode Section</h2>
                <label>
                    <input type="checkbox"
                           id="stealth_mode_toggle"
                           data-action="change->stealth-mode#toggle"
                           data-stealth-mode-target="toggle"
                           checked>
                    Enable Stealth Mode
                </label>
            </div>

            <!-- Stealth Summary Section -->
            <div id="stealth-mode-summary" data-stealth-mode-target="summary" class="section">
                <h2>Stealth Summary</h2>
                <p>Your project is in stealth mode.</p>
                <button type="button" data-action="click->stealth-mode#showFullForm">
                    Show Full Form
                </button>
            </div>

            <!-- Main Form Section -->
            <div id="main-project-form" data-stealth-mode-target="mainForm" class="section hidden">
                <h2>Main Project Form</h2>
                <p>This is the main form that should show/hide based on stealth mode.</p>
                <input type="text" placeholder="Project Name">
                <textarea placeholder="Project Description"></textarea>
            </div>

        </div>
    </div>

    <script>
        // Stealth Mode Controller Implementation
        class StealthModeController extends Stimulus.Controller {
            static targets = ["toggle", "customization", "section", "summary", "mainForm"]
            static values = { editMode: Boolean }

            connect() {
                console.log("Stealth Mode Controller connected", this.editModeValue);
                this.updateFormVisibility();
            }

            toggle() {
                console.log("Toggle called");
                this.updateFormVisibility();
            }

            updateFormVisibility() {
                const checkbox = this.hasToggleTarget ? this.toggleTarget : null;
                const isStealthMode = checkbox ? checkbox.checked : false;

                console.log("UpdateFormVisibility:", { isStealthMode, editMode: this.editModeValue });

                const mainForm = document.getElementById('main-project-form');
                const stealthSummary = document.getElementById('stealth-mode-summary');

                // In edit mode, don't auto-hide the form on initialization if stealth mode is enabled
                const isEditMode = this.hasEditModeValue && this.editModeValue;
                const shouldShowForm = !isStealthMode || (isEditMode && this.isInitialLoad);

                // Track if this is the initial page load
                if (!Object.prototype.hasOwnProperty.call(this, 'isInitialLoad')) {
                    this.isInitialLoad = true;
                }

                console.log("Visibility logic:", { shouldShowForm, isEditMode, isInitialLoad: this.isInitialLoad });

                // Update main form visibility
                if (mainForm) {
                    if (shouldShowForm) {
                        mainForm.classList.remove('hidden');
                        console.log("Showing main form");
                    } else {
                        mainForm.classList.add('hidden');
                        console.log("Hiding main form");
                    }
                }

                // Update stealth summary visibility
                if (stealthSummary) {
                    if (isStealthMode && !shouldShowForm) {
                        stealthSummary.classList.remove('hidden');
                        console.log("Showing stealth summary");
                    } else {
                        stealthSummary.classList.add('hidden');
                        console.log("Hiding stealth summary");
                    }
                }

                // After first update, mark as no longer initial load
                if (this.isInitialLoad) {
                    this.isInitialLoad = false;
                }
            }

            showFullForm(event) {
                event.preventDefault();
                console.log("ShowFullForm called");

                const mainForm = document.getElementById('main-project-form');
                const stealthSummary = document.getElementById('stealth-mode-summary');

                if (mainForm) {
                    mainForm.classList.remove('hidden');
                    console.log("Form shown via button");

                    if (stealthSummary) {
                        stealthSummary.classList.add('hidden');
                    }

                    // Update button state
                    const button = event.target;
                    button.textContent = 'Hide Full Form';
                    button.setAttribute('data-action', 'click->stealth-mode#hideFullForm');
                }
            }

            hideFullForm(event) {
                event.preventDefault();
                console.log("HideFullForm called");

                const mainForm = document.getElementById('main-project-form');
                const stealthSummary = document.getElementById('stealth-mode-summary');
                const isStealthMode = this.hasToggleTarget && this.toggleTarget.checked;

                if (mainForm && isStealthMode) {
                    mainForm.classList.add('hidden');

                    if (stealthSummary) {
                        stealthSummary.classList.remove('hidden');
                    }

                    // Update button state
                    const button = event.target;
                    button.textContent = 'Show Full Form';
                    button.setAttribute('data-action', 'click->stealth-mode#showFullForm');
                }
            }
        }

        // Register the controller
        const application = Stimulus.Application.start();
        application.register("stealth-mode", StealthModeController);
    </script>
</body>
</html>