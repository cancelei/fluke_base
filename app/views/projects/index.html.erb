<div class="py-8">
  <%# Header %>
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">My Projects</h1>
    <%= link_to new_project_path, class: "btn btn-primary btn-sm gap-2" do %>
      <%= render Ui::IconComponent.new(name: :plus, size: :sm) %>
      New Project
    <% end %>
  </div>

  <% if @projects.present? %>
    <%= turbo_frame_tag "projects_index" do %>
      <div class="card bg-base-100 shadow-xl">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>Project</th>
                <th>Stage</th>
                <th class="hidden md:table-cell">Milestones</th>
                <th class="hidden md:table-cell">Agreements</th>
                <th class="hidden sm:table-cell">Updated</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @projects.each do |project| %>
                <% presenter = present(project) %>
                <tr class="hover" data-controller="project-card" data-project-id="<%= project.id %>">
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="avatar placeholder">
                        <div class="bg-primary/10 text-primary rounded-lg w-10 h-10 flex items-center justify-center">
                          <%= render Ui::IconComponent.new(name: :folder, size: :md) %>
                        </div>
                      </div>
                      <div>
                        <%= link_to presenter.display_name(current_user), project_path(project),
                            class: "font-medium link link-hover",
                            data: { turbo_frame: "_top" } %>
                        <% if project.description.present? && field_visible_to_user?(project, :description, current_user) %>
                          <div class="text-xs text-base-content/60 line-clamp-1 max-w-xs">
                            <%= truncate(strip_tags(presenter.display_description(current_user)), length: 50) %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= presenter.stage_badge %>
                    <% if project.category.present? && field_visible_to_user?(project, :category, current_user) %>
                      <span class="badge badge-info badge-xs ml-1"><%= project.category %></span>
                    <% end %>
                  </td>
                  <td class="hidden md:table-cell">
                    <span class="font-medium"><%= presenter.milestones_summary %></span>
                  </td>
                  <td class="hidden md:table-cell">
                    <%= project.agreements.count %>
                  </td>
                  <td class="hidden sm:table-cell text-base-content/60 text-sm">
                    <%= time_ago_in_words(project.updated_at) %> ago
                  </td>
                  <td class="text-right">
                    <div class="flex items-center justify-end gap-1">
                      <%= link_to project_path(project),
                          class: "btn btn-primary btn-xs gap-1",
                          data: { turbo_frame: "_top" } do %>
                        <%= render Ui::IconComponent.new(name: :eye, size: :xs) %>
                        View
                      <% end %>

                      <% if current_user.id == project.user_id %>
                        <%= link_to edit_project_path(project),
                            class: "btn btn-ghost btn-xs",
                            data: { turbo_frame: "_top" },
                            title: "Edit" do %>
                          <%= render Ui::IconComponent.new(name: :edit, size: :xs) %>
                        <% end %>

                        <div class="dropdown dropdown-end">
                          <div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-square" title="More">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                            </svg>
                          </div>
                          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-50 w-40 p-2 shadow-xl border border-base-300">
                            <li>
                              <button type="button" data-action="click->project-card#copyLink" class="gap-2 text-sm">
                                <%= render Ui::IconComponent.new(name: :document, size: :sm) %>
                                Copy Link
                              </button>
                            </li>
                            <li>
                              <%= button_to project_path(project),
                                  method: :delete,
                                  data: { turbo_confirm: "Delete this project?", turbo_frame: "_top" },
                                  class: "text-error gap-2 text-sm" do %>
                                <%= render Ui::IconComponent.new(name: :trash, size: :sm) %>
                                Delete
                              <% end %>
                            </li>
                          </ul>
                        </div>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <%# Pagination %>
      <div class="mt-6">
        <%= render partial: "shared/pagination", locals: { records: @projects, class_name: "flex justify-center", remote: true } %>
      </div>
    <% end %>
  <% else %>
    <%# Compact Empty State %>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body items-center text-center py-12">
        <%= render Ui::IconComponent.new(name: :folder, size: :xl, css_class: "text-base-content/30 mb-4") %>
        <p class="text-base-content/60">No projects yet.</p>
        <%= link_to new_project_path, class: "btn btn-primary btn-sm gap-2 mt-4" do %>
          <%= render Ui::IconComponent.new(name: :plus, size: :sm) %>
          Create Project
        <% end %>
      </div>
    </div>
  <% end %>
</div>
