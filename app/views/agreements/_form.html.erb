<%
  @milestones = Milestone.where(project_id: @project.id) || []
  @milestone_ids = @agreement_form&.milestone_ids_array || []
%>

<div data-controller="agreement-form form-submission">
  <% form_options = if agreement.persisted?
       { model: agreement, url: agreement_path(agreement), method: :patch, class: "space-y-6", data: { action: "submit->form-submission#submit" } }
     else
       { model: agreement, class: "space-y-6", data: { turbo: false, action: "submit->form-submission#submit" } }
     end %>
  <%= form_with(**form_options) do |form| %>
      <%= form.hidden_field :project_id, value: @project.id if @project %>
      <%= form.hidden_field :initiator_user_id, value: current_user.id %>
      <% other_party_id = @agreement_form&.other_party_user_id || params[:other_party_id] %>
      <%= form.hidden_field :other_party_user_id, value: other_party_id %>
      <%= form.hidden_field :counter_agreement_id, value: params[:counter_to_id] %>

      <% if current_user.id != @project&.user_id %>
        <div class="alert alert-info mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <div>
            <h3 class="font-bold">
              You're initiating an agreement with <%= @project ? @project.user&.full_name : "an entrepreneur" %>
            </h3>
            <div class="text-sm">
              You'll be proposing to collaborate on project "<%= @project ? present(@project).display_name(current_user) : "to be determined" %>". The entrepreneur will need to accept this agreement before collaboration can begin.
            </div>
          </div>
        </div>
      <% end %>

      <fieldset class="fieldset">
        <%= form.label :start_date, class: "fieldset-legend" %>
        <%= form.date_field :start_date, class: "input input-bordered w-full" %>
      </fieldset>

      <fieldset class="fieldset">
        <%= form.label :end_date, class: "fieldset-legend" %>
        <%= form.date_field :end_date, class: "input input-bordered w-full" %>
      </fieldset>

      <fieldset class="fieldset">
        <%= form.label :weekly_hours, "Weekly Hours Commitment", class: "fieldset-legend" %>
        <%= form.number_field :weekly_hours, min: 1, class: "input input-bordered w-full" %>
        <p class="text-xs text-base-content/60 mt-1">Estimated hours of work per week (leave blank for co-founder agreement)</p>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Payment Type</legend>
        <div class="space-y-2">
          <label class="flex items-center gap-3 cursor-pointer">
            <%= form.radio_button :payment_type, Agreement::HOURLY,
                data: {
                  action: "change->agreement-form#togglePaymentFields",
                  agreement_form_target: "paymentType"
                },
                class: "radio radio-primary" %>
            <span class="text-sm">Hourly Rate</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer">
            <%= form.radio_button :payment_type, Agreement::EQUITY,
                data: {
                  action: "change->agreement-form#togglePaymentFields",
                  agreement_form_target: "paymentType"
                },
                class: "radio radio-primary" %>
            <span class="text-sm">Equity Only</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer">
            <%= form.radio_button :payment_type, Agreement::HYBRID,
                data: {
                  action: "change->agreement-form#togglePaymentFields",
                  agreement_form_target: "paymentType"
                },
                class: "radio radio-primary" %>
            <span class="text-sm">Hybrid (Hourly + Equity)</span>
          </label>
        </div>
      </fieldset>

      <fieldset class="fieldset hourly-field" data-agreement-form-target="hourlyField">
        <%= form.label :hourly_rate, "Hourly Rate (USD)", class: "fieldset-legend" %>
        <%= form.number_field :hourly_rate, min: 0, step: 0.01, class: "input input-bordered w-full" %>
      </fieldset>

      <fieldset class="fieldset equity-field" data-agreement-form-target="equityField">
        <%= form.label :equity_percentage, "Equity Percentage (%)", class: "fieldset-legend" %>
        <%= form.number_field :equity_percentage, min: 0.01, max: 99.99, step: 0.01, class: "input input-bordered w-full" %>
      </fieldset>

      <fieldset class="fieldset">
        <%= form.label :tasks, "Tasks and Responsibilities", class: "fieldset-legend" %>
        <%= form.text_area :tasks, rows: 4, class: "textarea textarea-bordered w-full" %>
        <p class="text-xs text-base-content/60 mt-1">Describe the specific tasks and responsibilities for this agreement</p>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Milestones</legend>
        <div class="space-y-2">
          <% if @milestones.any? %>
            <% @milestones.each_with_index do |milestone, index| %>
              <label class="flex items-center gap-3 cursor-pointer">
                <%= check_box_tag "agreement[milestone_ids][]", milestone.id, @milestone_ids.include?(milestone.id),
                    id: "milestone_#{index}",
                    class: "checkbox checkbox-primary" %>
                <span class="text-sm"><%= milestone.title %></span>
              </label>
            <% end %>
          <% else %>
            <div class="alert alert-warning">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
              <div>
                <h3 class="font-bold">No milestones available</h3>
                <div class="text-sm">This project needs milestones before you can create an agreement.
                  <% if @project && policy(@project).manage_milestones? %>
                    <%= link_to "Add milestones", project_path(@project, anchor: "milestones"), class: "link link-primary" %>
                  <% else %>
                    Please ask the project owner to add milestones first.
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
          <% if agreement.errors[:milestone_ids] %>
            <p class="text-xs text-error mt-1">Select at least one milestone</p>
          <% end %>
        </div>
      </fieldset>

      <fieldset class="fieldset">
        <%= form.label :terms, "Additional Terms", class: "fieldset-legend" %>
        <%= form.text_area :terms, rows: 4, class: "textarea textarea-bordered w-full" %>
      </fieldset>

    <div class="mt-6 flex justify-end gap-3">
      <% if !agreement.persisted? && @project %>
        <% if params[:counter_to_id].present? %>
          <%= form.submit "Counter Offer",
              class: "btn btn-warning",
              data: { form_submission_target: "submit", loading_text: "Submitting counter offer..." },
              disabled: @milestones.empty? %>
        <% else %>
          <%= form.submit "Create Agreement",
              class: "btn btn-primary",
              data: { form_submission_target: "submit", loading_text: "Creating agreement..." },
              disabled: @milestones.empty? %>
        <% end %>
      <% elsif agreement.persisted? %>
        <% current_participant = agreement.agreement_participants.find_by(user_id: current_user.id) %>

        <% if policy(@agreement).edit? && !@agreement.countered? %>
          <%= form.submit "Update Agreement",
              class: "btn btn-primary",
              data: { form_submission_target: "submit", loading_text: "Updating agreement..." } %>
        <% end %>

        <% if current_participant&.can_accept_agreement? %>
          <%= button_to "Accept Agreement", accept_agreement_path(@agreement),
              method: :patch,
              class: "btn btn-success",
              data: { turbo_confirm: "Are you sure you want to accept this agreement?" } %>
        <% end %>

        <% if current_participant&.can_reject_agreement? %>
          <%= button_to "Reject Agreement", reject_agreement_path(@agreement),
              method: :patch,
              class: "btn btn-error",
              data: { turbo_confirm: "Are you sure you want to reject this agreement?" } %>
        <% end %>

        <% if current_participant&.can_make_counter_offer? %>
          <%= button_to "Counter Offer", counter_offer_agreement_path(@agreement),
              method: :post,
              class: "btn btn-warning",
              data: { turbo_confirm: "Are you sure you want to make a counter offer?" } %>
        <% end %>

        <% if policy(@agreement).cancel? && !@agreement.countered? %>
          <%= button_to "Cancel Agreement", cancel_agreement_path(@agreement),
              method: :patch,
              class: "btn btn-error",
              data: { turbo_confirm: "Are you sure you want to cancel this agreement?" } %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
