<% presenter = present(agreement) %>
<%= turbo_frame_tag dom_id(agreement) do %>
  <div class="card bg-base-100 shadow-xl overflow-hidden">
    <%= render "agreement_show_status", agreement: agreement %>

    <div class="border-t border-base-200">
    <dl class="divide-y divide-base-200">
      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Project</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= link_to project.name, project, class: "link link-primary", data: { turbo_frame: "_top" } %>
        </dd>
      </div>

      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Parties</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.parties_display %>
        </dd>
      </div>

      <div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Duration</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.duration_display %>
        </dd>
      </div>

      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Total Commitment</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.total_commitment_display %>
        </dd>
      </div>

      <div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Payment Details</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.payment_type_badge %>
          <div class="mt-2 text-sm text-base-content/80">
            <%= presenter.formatted_payment_details %>
          </div>
          <div class="mt-2 text-sm text-base-content/80">
            <%= presenter.financial_summary %>
          </div>
        </dd>
      </div>

      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Tasks and Responsibilities</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <% if agreement.tasks.present? %>
            <%= simple_format(agreement.tasks) %>
          <% else %>
            Not specified
          <% end %>
        </dd>
      </div>

      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Milestones Progress</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.milestone_progress %>
        </dd>
      </div>

      <div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Progress Summary</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.progress_summary %>
        </dd>
      </div>

      <div class="bg-base-200/50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-sm font-medium text-base-content/70">Time Remaining</dt>
        <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
          <%= presenter.time_remaining %>
        </dd>
      </div>

      <% if agreement.terms.present? %>
        <div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-base-content/70">Additional Terms</dt>
          <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
            <%= simple_format(agreement.terms) %>
          </dd>
        </div>
      <% end %>

      <% if !can_view_full_details && agreement.other_party == current_user && agreement.pending? %>
        <div class="alert alert-warning m-4">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <div>
            <h3 class="font-medium">Limited Access</h3>
            <p class="text-sm">
              You'll gain full access to this project's details after accepting the agreement.
            </p>
          </div>
        </div>
      <% end %>

      <!-- Counter offer history section (if this agreement has counter offers or is a counter offer) -->
      <% if agreement.has_counter_offers? || agreement.is_counter_offer? %>
        <div class="alert alert-warning m-4">
          <dt class="text-sm font-medium">Negotiation History</dt>
          <dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">
            <%= presenter.counter_offer_info %>
          </dd>
        </div>
      <% end %>

      <!-- Add this after the agreement details section, before any action buttons -->
      <% if agreement.countered? %>
        <div class="alert alert-warning m-4">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <div>
            <h3 class="font-medium">This agreement has been countered</h3>
            <p class="text-sm">
              This agreement is no longer active because a counter offer has been made.
              You should review the latest counter offer.
            </p>

            <% if agreement.counter_offers.any? %>
              <div class="mt-4">
                <%= link_to "View Latest Counter Offer", agreement_path(agreement.counter_offers.order(created_at: :desc).first),
                    class: "btn btn-warning btn-sm",
                    data: { turbo_frame: "_top" } %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </dl>
    </div>
  </div>
<% end %>

<!-- Lazy-loaded sections with loading placeholders -->

<!-- GitHub Integration Section -->
<%= turbo_frame_tag "#{dom_id(agreement)}_github",
    src: github_section_agreement_path(agreement),
    loading: "lazy" do %>
  <%= render "lazy_loading_placeholder",
      title: "GitHub Integration",
      description: "Repository access and development activity" %>
<% end %>

<!-- Time Logs Section -->
<%= turbo_frame_tag "#{dom_id(agreement)}_time_logs",
    src: time_logs_section_agreement_path(agreement),
    loading: "lazy" do %>
  <%= render "lazy_loading_placeholder",
      title: "Time Tracking",
      description: "Hours spent and remaining time for this agreement" %>
<% end %>

<!-- Meetings Section -->
<%= turbo_frame_tag "#{dom_id(agreement)}_meetings",
    src: meetings_section_agreement_path(agreement),
    loading: "lazy" do %>
  <%= render "lazy_loading_placeholder",
      title: "Meetings",
      description: "Scheduled meetings and collaboration sessions" %>
<% end %>

<!-- Counter Offers Section -->
<%= turbo_frame_tag "#{dom_id(agreement)}_counter_offers",
    src: counter_offers_section_agreement_path(agreement),
    loading: "lazy" do %>
  <%= render "lazy_loading_placeholder",
      title: "Negotiation History",
      description: "Changes and counter-offers made during negotiation" %>
<% end %>
