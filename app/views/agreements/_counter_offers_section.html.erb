<%= turbo_frame_tag "#{dom_id(agreement)}_counter_offers" do %>
  <% if agreement_chain.any? %>
    <div class="mt-8 bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Negotiation History
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
          Changes and counter-offers made during negotiation
        </p>
      </div>

      <div class="border-t border-gray-200">
        <div class="px-4 py-5">
          <% agreement_chain.each_with_index do |(current_agreement, previous_agreement), idx| %>
            <div class="mb-6 <%= "pb-6 border-b border-gray-200" unless idx == agreement_chain.length - 1 %>">
              <h4 class="font-bold text-indigo-700 mb-3 flex items-center">
                <% if agreement_chain.last == [current_agreement, previous_agreement] %>
                  <svg class="h-5 w-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Initial Agreement
                <% else %>
                  <svg class="h-5 w-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m0-4l4-4"></path>
                  </svg>
                  Counter Offer <%= agreement_chain.length - idx - 1 %>
                <% end %>

                <span class="ml-2 text-sm font-normal text-gray-600">
                  by <%= current_agreement.initiator&.full_name %>
                </span>

                <% if current_agreement.initiator&.id == current_user.id %>
                  <span class="ml-2 inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">You</span>
                <% end %>
              </h4>

              <div class="bg-gray-50 rounded-lg p-4">
                <%= render partial: "agreement_changes", locals: { agreement: current_agreement, previous_agreement: previous_agreement } %>

                <div class="mt-3 flex items-center justify-between text-xs text-gray-500">
                  <span>
                    Created: <%= current_agreement.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                  </span>
                  <span class="flex items-center">
                    Status:
                    <span class="ml-1 px-2 py-1 rounded-full text-xs font-medium <%=
                      case current_agreement.status
                      when "accepted" then "bg-green-100 text-green-800"
                      when "rejected" then "bg-red-100 text-red-800"
                      when "pending" then "bg-yellow-100 text-yellow-800"
                      when "countered" then "bg-orange-100 text-orange-800"
                      else "bg-gray-100 text-gray-800"
                      end
                                                                                 %>">
                      <%= current_agreement.status.humanize %>
                    </span>
                  </span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
