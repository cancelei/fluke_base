<% if @project.user_id == current_user.id && (@agreement.active? || @agreement.completed?) %>
  <% presenter = present(@agreement) %>
  <% kpis = presenter.kpi_metrics_for_owner(current_user) %>

  <!-- Agreement Performance KPIs for Project Owner (DaisyUI Stats Component) -->
  <div class="card bg-base-100 shadow-lg border-l-4 border-primary mb-6">
    <div class="card-body">
      <div class="flex items-center gap-3 mb-4">
        <div class="bg-primary/10 p-2 rounded-lg">
          <svg class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012-2m-6 0h6" />
          </svg>
        </div>
        <h3 class="card-title">Agreement Performance Overview</h3>
      </div>

      <!-- DaisyUI Stats Component -->
      <div class="stats stats-vertical lg:stats-horizontal shadow-sm bg-base-200">
        <!-- Hours Performance Stat -->
        <% if kpis[:hours_performance].present? %>
          <% hours_kpi = kpis[:hours_performance] %>
          <div class="stat">
            <div class="stat-figure text-info">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="stat-title">Time Commitment</div>
            <div class="stat-value text-info text-2xl">
              <%= hours_kpi[:performance_ratio].present? ? "#{hours_kpi[:performance_ratio].to_i}%" : "N/A" %>
            </div>
            <div class="stat-desc"><%= hours_kpi[:message] %></div>
            <div class="stat-actions">
              <span class="badge badge-sm <%= kpi_badge_class(hours_kpi[:status]) %>">
                <%= hours_kpi[:status].humanize %>
              </span>
            </div>
            <% if hours_kpi[:performance_ratio].present? %>
              <progress class="progress progress-info w-full mt-2" value="<%= [ hours_kpi[:performance_ratio], 100 ].min %>" max="100"></progress>
            <% end %>
          </div>
        <% end %>

        <!-- Timeline Performance Stat -->
        <% if kpis[:timeline_performance].present? %>
          <% timeline_kpi = kpis[:timeline_performance] %>
          <div class="stat">
            <div class="stat-figure text-primary">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <div class="stat-title">Timeline</div>
            <div class="stat-value text-primary text-2xl">
              <%= timeline_kpi[:days_remaining] || "Active" %>
            </div>
            <div class="stat-desc"><%= timeline_kpi[:message] %></div>
            <div class="stat-actions">
              <span class="badge badge-sm <%= kpi_badge_class(timeline_kpi[:status]) %>">
                <%= timeline_kpi[:status].humanize %>
              </span>
            </div>
          </div>
        <% end %>

        <!-- Milestone Performance Stat -->
        <% if kpis[:milestone_performance].present? %>
          <% milestone_kpi = kpis[:milestone_performance] %>
          <div class="stat">
            <div class="stat-figure text-success">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="stat-title">Milestones</div>
            <div class="stat-value text-success text-2xl">
              <%= milestone_kpi[:completion_rate].present? ? "#{milestone_kpi[:completion_rate].to_i}%" : "0%" %>
            </div>
            <div class="stat-desc"><%= milestone_kpi[:message] %></div>
            <div class="stat-actions">
              <span class="badge badge-sm <%= kpi_badge_class(milestone_kpi[:status]) %>">
                <%= milestone_kpi[:status].humanize %>
              </span>
            </div>
            <% if milestone_kpi[:completion_rate].present? %>
              <progress class="progress progress-success w-full mt-2" value="<%= milestone_kpi[:completion_rate] %>" max="100"></progress>
            <% end %>
          </div>
        <% end %>

        <!-- Cost Efficiency Stat -->
        <% if kpis[:cost_efficiency].present? %>
          <% cost_kpi = kpis[:cost_efficiency] %>
          <div class="stat">
            <div class="stat-figure text-warning">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="stat-title">Cost Tracking</div>
            <div class="stat-value text-warning text-2xl">
              <%= cost_kpi[:spent_amount] || "$0" %>
            </div>
            <div class="stat-desc"><%= cost_kpi[:message] %></div>
            <div class="stat-actions">
              <span class="badge badge-sm <%= kpi_badge_class(cost_kpi[:status]) %>">
                <%= cost_kpi[:status].humanize %>
              </span>
            </div>
          </div>
        <% end %>

        <!-- Overall Status Stat -->
        <% if kpis[:completion_status].present? %>
          <% status_kpi = kpis[:completion_status] %>
          <div class="stat">
            <div class="stat-figure text-secondary">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="stat-title">Overall Status</div>
            <div class="stat-value text-secondary text-2xl">
              <%= @agreement.completed? ? "Complete" : "Active" %>
            </div>
            <div class="stat-desc"><%= status_kpi[:message] %></div>
            <div class="stat-actions">
              <span class="badge badge-sm <%= kpi_badge_class(status_kpi[:status]) %>">
                <%= status_kpi[:status].humanize %>
              </span>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Additional insights for completed agreements -->
      <% if @agreement.completed? %>
        <div class="alert alert-success mt-6">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h4 class="font-semibold">Agreement Completed</h4>
            <p class="text-sm">
              This agreement has been successfully completed. All performance metrics reflect the final results.
              <% if kpis[:hours_performance][:hours_logged].present? %>
                A total of <strong><%= kpis[:hours_performance][:hours_logged] %> hours</strong> were logged during this engagement.
              <% end %>
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
