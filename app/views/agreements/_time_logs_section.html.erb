<%= turbo_frame_tag "#{dom_id(agreement)}_time_logs" do %>
<%# Fallback: calculate agreement participant time logs if not provided %>
<% unless defined?(agreement_participant_time_logs) %>
  <% if project.user_id == current_user.id %>
<%# Project owner: only show the other party's time logs %>
    <% other_party = agreement.other_party %>
    <% agreement_participant_time_logs = other_party ? project.time_logs.where(user_id: other_party.id) : project.time_logs.none %>
  <% else %>
<%# Agreement participant: show all agreement participants' time logs %>
    <% agreement_participant_ids = agreement.agreement_participants.pluck(:user_id) %>
    <% agreement_participant_time_logs = project.time_logs.where(user_id: agreement_participant_ids) %>
  <% end %>
<% end %>

<div class="mt-8 card bg-base-100 shadow-xl overflow-hidden">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium">
        Time Tracking
      </h3>
      <p class="mt-1 max-w-2xl text-sm text-base-content/70">
        <% if project.user_id == current_user.id %>
          Hours spent by <%= agreement.other_party&.full_name || "the other party" %> for this agreement
        <% else %>
          Hours spent and remaining time for this agreement
        <% end %>
      </p>
    </div>

    <div class="border-t border-base-200">
      <% if agreement.active? || agreement.completed? %>
        <div class="px-4 py-5">
          <% if project.user_id == current_user.id %>
<%# Project owner: show other party's time progress %>
            <%= render "time_logs/remaining_time_progress", agreement:, project:, current_log: nil, owner: true %>

<%# Enhanced analytics for completed agreements when viewed by project owner %>
            <% if agreement.completed? %>
              <%= render "completed_agreement_time_analysis", agreement:, project:, agreement_participant_time_logs: %>
            <% end %>
          <% else %>
<%# Agreement participant: show agreement-specific progress %>
            <%= render "time_logs/remaining_time_progress", agreement:, project:, current_log: nil %>
          <% end %>

          <% if can_view_full_details && (defined?(agreement_participant_time_logs) && agreement_participant_time_logs.any?) %>
            <div class="mt-6">
              <h4 class="text-sm font-medium mb-3">Recent Time Entries</h4>
              <div class="space-y-2">
                <% agreement_participant_time_logs.includes(:user).order(created_at: :desc).limit(10).each do |time_log| %>
                  <div class="flex items-center justify-between py-2 px-3 bg-base-200/50 rounded-md">
                    <div class="flex items-center">
                      <div class="flex-shrink-0">
                        <% if time_log.status == 'in_progress' %>
                          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
                        <% else %>
                          <div class="w-2 h-2 bg-base-content/40 rounded-full"></div>
                        <% end %>
                      </div>
                      <div class="ml-3">
                        <p class="text-sm font-medium">
                          <%= time_log.user.full_name %>
                        </p>
                        <% if time_log.description.present? %>
                          <p class="text-xs text-base-content/70 truncate max-w-xs">
                            <%= time_log.description %>
                          </p>
                        <% end %>
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-sm">
                        <% if time_log.status == 'in_progress' %>
                          <span class="text-success">In Progress</span>
                        <% else %>
                          <%= pluralize(time_log.hours_spent.to_i, "hour") %>
                          <% if time_log.hours_spent % 1 != 0 %>
                            <%= (time_log.hours_spent % 1 * 60).to_i %>m
                          <% end %>
                        <% end %>
                      </p>
                      <p class="text-xs text-base-content/70">
                        <%= time_log.created_at.strftime("%b %d, %Y") %>
                      </p>
                    </div>
                  </div>
                <% end %>
              </div>
              <%= link_to time_logs_path(project),
                  class: "inline-flex items-center mt-4 link link-primary text-sm" do %>
                View detailed time logs
                <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              <% end %>
            </div>
          <% elsif !defined?(agreement_participant_time_logs) || agreement_participant_time_logs.empty? %>
            <div class="mt-6 text-center py-6">
              <p class="text-base-content/70 text-sm">No time entries recorded yet.</p>
              <% if agreement.active? %>
                <p class="text-base-content/50 text-xs mt-2">
                  Time tracking will appear here once work begins.
                </p>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="px-4 py-8 text-center">
          <div class="text-base-content/40">
            <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <p class="mt-2 text-sm text-base-content/70">
            Time tracking will be available once the agreement is active.
          </p>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
