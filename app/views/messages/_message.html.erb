<div id="<%= dom_id(message) %>" class="<%= message.user == current_user ? 'flex justify-end mb-2' : 'flex mb-2' %>">
  <div class="<%= message.user == current_user ? 'bg-indigo-500 text-white rounded-lg py-2 px-4' : 'bg-gray-200 rounded-lg py-2 px-4' %> <%= message.audio.attached? ? 'max-w-sm' : 'max-w-xs' %>">
    <div class="mb-2">
      <% if message.attachments.attached? %>
        <div class="mb-1 space-y-2">
          <% message.attachments.each do |file| %>
            <% content_type = file.content_type %>
            <% if content_type.start_with?("image/") %>
              <div>
                <%= image_tag url_for(file), alt: file.filename.to_s, class: "rounded max-h-48 mb-1" %>
              </div>
            <% elsif content_type.start_with?("video/") %>
              <div>
                <video controls class="rounded max-h-48 mb-1">
                  <source src="<%= url_for(file) %>" type="<%= content_type %>">
                  Your browser does not support the video tag.
                </video>
              </div>
            <% elsif content_type.start_with?("audio/") %>
              <div>
                <audio controls class="mb-1">
                  <source src="<%= url_for(file) %>" type="<%= content_type %>">
                  Your browser does not support the audio element.
                </audio>
              </div>
            <% else %>
              <div>
                <%= link_to file.filename.to_s, url_for(file), target: "_blank", class: "underline" %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
      <% if message.audio.attached? %>
        <div class="<%= message.user == current_user ? 'bg-indigo-600 bg-opacity-80' : 'bg-gray-100' %> rounded-lg p-3 mb-2">
          <!-- Voice Message Header -->
          <div class="flex items-center mb-2">
            <svg class="w-4 h-4 <%= message.user == current_user ? 'text-white' : 'text-gray-500' %> mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 14.5s-1.5 0-1.5-1.5.5-3 2-3 2 2.5 2 3-.5 1.5-1.5 1.5zm0-5c-1.33 0-2.42.83-2.83 2H7.5c-.28 0-.5.22-.5.5s.22.5.5.5h1.67c.41 1.17 1.5 2 2.83 2s2.42-.83 2.83-2H16.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5h-1.67C14.42 10.83 13.33 10 12 10z"/>
            </svg>
            <span class="text-xs <%= message.user == current_user ? 'text-white' : 'text-gray-600' %> font-medium">Voice Message</span>
          </div>
          
          <!-- Audio Player -->
          <div data-controller="audio-player" data-audio-player-src-value="<%= url_for(message.audio) %>">
            <div class="flex items-center space-x-3">
              <!-- Play/Pause Button -->
              <button type="button" 
                      data-audio-player-target="playBtn"
                      data-action="click->audio-player#togglePlayback"
                      class="flex items-center justify-center w-10 h-10 rounded-full <%= message.user == current_user ? 'bg-white text-indigo-600 hover:bg-gray-50' : 'bg-indigo-600 hover:bg-indigo-700 text-white' %> transition-colors shadow-sm"
                      title="Play voice message">
                <svg data-audio-player-target="playIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                <svg data-audio-player-target="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>
              </button>
              
              <!-- Progress and Waveform -->
              <div class="flex-1">
                <!-- Progress Bar -->
                <div class="<%= message.user == current_user ? 'bg-white bg-opacity-30' : 'bg-gray-200' %> rounded-full h-2 mb-2 relative overflow-hidden">
                  <div data-audio-player-target="progress" 
                       class="absolute left-0 top-0 h-full <%= message.user == current_user ? 'bg-white' : 'bg-indigo-500' %> rounded-full transition-all duration-100"
                       style="width: 0%"></div>
                </div>
                
                <!-- Waveform Visualization -->
                <div class="flex items-center justify-center h-6">
                  <div data-audio-player-target="waveform" class="flex items-center space-x-1 <%= message.user == current_user ? 'text-white' : 'text-gray-400' %>">
                    <!-- Waveform bars generated by JavaScript -->
                  </div>
                </div>
              </div>
              
              <!-- Duration Display -->
              <div class="text-xs <%= message.user == current_user ? 'text-white' : 'text-gray-500' %> font-mono text-center min-w-[3rem]">
                <div data-audio-player-target="currentTime">0:00</div>
                <div class="text-[10px] <%= message.user == current_user ? 'text-white opacity-70' : 'opacity-60' %>">/</div>
                <div data-audio-player-target="duration">0:00</div>
              </div>
            </div>
            
            <!-- Hidden audio element -->
            <audio data-audio-player-target="audio" preload="metadata" class="hidden">
              <source src="<%= url_for(message.audio) %>" type="<%= message.audio.content_type %>">
              Your browser does not support the audio element.
            </audio>
          </div>
        </div>
      <% end %>
    </div>
    <p class="text-sm"><%== message.body %></p>
    <p class="text-xs text-right mt-1 <%= message.user == current_user ? 'text-indigo-100' : 'text-gray-500' %>">
      <%= local_assigns.fetch(:timestamp, message.created_at).strftime("%H:%M") %>
    </p>
  </div>
</div>