<div id="completed_tasks_section" class="card bg-base-100 shadow-xl">
  <div class="px-6 py-5 bg-success/10 border-b border-base-200">
    <h3 class="text-lg font-bold text-success flex items-center">
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Time Logs for Completed Tasks
    </h3>
  </div>
  <div class="overflow-hidden">
    <% if time_logs_completed.any? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
          <tr>
            <th class="text-xs font-semibold uppercase tracking-wider">
              User
            </th>
            <th class="text-xs font-semibold uppercase tracking-wider">
              Milestone
            </th>
            <th class="text-xs font-semibold uppercase tracking-wider">
              Due Date
            </th>
            <th class="text-xs font-semibold uppercase tracking-wider">
              Started
            </th>
            <th class="text-xs font-semibold uppercase tracking-wider">
              Ended
            </th>
            <th class="text-xs font-semibold uppercase tracking-wider">
              Duration
            </th>
          </tr>
          </thead>
          <tbody>
          <% time_log_users = owner ? project.time_logs.map(&:user).uniq : [ current_user, project.user ].compact %>
          <% time_log_users.each do |user| %>
            <% time_logs_completed.each do |milestone| %>
                <% next unless milestone.time_logs.where(user: user).any? %>

                <tr class="hover">
                  <td class="whitespace-nowrap">
                    <div class="text-sm font-medium text-primary truncate">
                      <%= user.full_name %>
                      <% if user.id == project.user_id %>
                        <span class="badge badge-success badge-sm ml-2">owner</span>
                      <% end %>
                    </div>
                  </td>
                  <td class="whitespace-nowrap">
                    <div class="text-sm font-medium text-primary truncate">
                      <%= milestone.title %>
                    </div>
                  </td>
                  <td class="whitespace-nowrap">
                    <div class="text-sm">
                      <%= milestone.due_date.strftime("%b %d, %Y %I:%M %p") %>
                    </div>
                  </td>
                  <td class="whitespace-nowrap">
                    <div class="text-sm">
                      <ul>
                        <% milestone.time_logs.where(user:).pluck(:started_at).each do |log| %>
                          <li><%= log.strftime("%b %d, %Y %I:%M %p") %></li>
                        <% end %>
                      </ul>
                    </div>
                  </td>
                  <td class="whitespace-nowrap">
                    <div class="text-sm">
                      <ul>
                        <% milestone.time_logs.where(user:).each do |log| %>
                          <li class="flex items-center gap-2">
                            <%= log.ended_at&.strftime("%b %d, %Y %I:%M %p") || "-" %>
                            <% if log.manual_entry %>
                              <div class="dropdown dropdown-hover dropdown-left">
                                <div tabindex="0" role="button" class="badge badge-success badge-sm cursor-pointer">m</div>
                                <div tabindex="0" class="dropdown-content z-[1] card card-compact shadow-xl bg-base-100 w-64 p-3">
                                  <div class="font-semibold text-sm">Justification:</div>
                                  <div class="text-sm text-base-content/70"><%= log.description.presence || "No justification provided." %></div>
                                </div>
                              </div>
                            <% end %>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  </td>
                  <td class="whitespace-nowrap text-sm text-base-content/70">
                    <% hours_spend = milestone.time_logs.where(user:).pluck(:hours_spent).sum %>
                    <%= hours_spend > 0 ? "#{hours_spend} hours" : "Less than an hour" %>
                  </td>
                </tr>
              <% end %>
          <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="px-4 py-8 text-center text-base-content/60">
        No time logs found. Start tracking time for a milestone above.
      </div>
    <% end %>
  </div>
</div>
