<div class="py-8">
  <%# Simplified Breadcrumbs %>
  <div class="breadcrumbs text-sm mb-4">
    <ul>
      <li><%= link_to "Dashboard", root_path %></li>
      <li><%= link_to "Community", explore_people_path %></li>
      <li class="font-semibold"><%= @person.full_name %></li>
    </ul>
  </div>

  <%# Profile Header Component - combines avatar, name, stats (ONCE), social, actions, affinity %>
  <div class="mb-6">
    <%= render Users::ProfileHeaderComponent.new(
      person: @person,
      current_user:,
      shared_agreements_count: @shared_agreements_count || 0
    ) %>
  </div>

  <%# Navigation Tabs %>
  <div class="tabs tabs-boxed bg-base-100 shadow-lg mb-6 p-2 gap-1">
    <a href="#about" class="tab tab-lg tab-active">About</a>
    <a href="#projects" class="tab tab-lg">Projects</a>
    <a href="#track" class="tab tab-lg">Track Record</a>
  </div>

  <%# Content Sections %>
  <div class="space-y-6">
    <%# About Section - Bio only, NO duplicate stats %>
    <section id="about" class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg mb-3">
          <%= render Ui::IconComponent.new(name: :user, size: :md, css_class: "text-primary") %>
          About
        </h2>
        <% presenter = present(@person) rescue nil %>
        <% bio_content = presenter&.formatted_bio %>
        <div class="prose prose-sm max-w-none">
          <% if bio_content.present? && bio_content != "No bio provided" %>
            <%= bio_content %>
          <% elsif current_user == @person %>
            <p class="text-base-content/70">
              <%= link_to "Add a bio to tell others about yourself", profile_edit_path, class: "link link-primary" %>
            </p>
          <% else %>
            <p class="text-base-content/70">No bio provided yet.</p>
          <% end %>
        </div>
      </div>
    </section>

    <%# Projects Section - Compact Table %>
    <section id="projects" class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg mb-3">
          <%= render Ui::IconComponent.new(name: :folder, size: :md, css_class: "text-primary") %>
          Projects
        </h2>

        <% if @projects_involved.any? %>
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Stage</th>
                  <th>Created</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @projects_involved.uniq.each do |project| %>
                  <tr class="hover">
                    <td>
                      <%= link_to project.name, project_path(project), class: "link link-hover font-medium" %>
                      <% if project.project_link.present? && field_visible_to_user?(project, :project_link, current_user) %>
                        <% safe_url = begin
                             uri = URI.parse(project.project_link.start_with?("http") ? project.project_link : "https://#{project.project_link}")
                             %w[http https].include?(uri.scheme) ? uri.to_s : nil
                           rescue URI::InvalidURIError
                             nil
                           end %>
                        <% if safe_url %>
                          <br>
                          <%= link_to safe_url, target: "_blank", class: "text-xs text-info link link-hover" do %>
                            <%= truncate(project.project_link, length: 30) %>
                            <%= render Ui::IconComponent.new(name: :chevron_right, size: :xs) %>
                          <% end %>
                        <% end %>
                      <% end %>
                    </td>
                    <td>
                      <span class="badge badge-sm badge-outline"><%= project.stage&.capitalize %></span>
                    </td>
                    <td class="text-base-content/60 text-sm">
                      <%= time_ago_in_words(project.created_at) %> ago
                    </td>
                    <td class="text-right">
                      <% if current_user != @person %>
                        <%= link_to new_agreement_path(project_id: project.id, other_party_id: @person.id), class: "btn btn-primary btn-xs gap-1" do %>
                          <%= render Ui::IconComponent.new(name: :plus, size: :xs) %>
                          Agreement
                        <% end %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-6 text-base-content/60">
            <p>No projects found for this user.</p>
          </div>
        <% end %>
      </div>
    </section>

    <%# Track Record Section %>
    <section id="track" class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg mb-3">
          <%= render Ui::IconComponent.new(name: :document, size: :md, css_class: "text-primary") %>
          Track Record
        </h2>
        <%= render partial: "shared/track_record", locals: { user: @person, agreements: @person.received_agreements } %>
      </div>
    </section>
  </div>
</div>
