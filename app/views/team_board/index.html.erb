<%# Team Board - Kanban-style WeDo Task Management %>
<div class="max-w-full" data-controller="team-board" data-team-board-project-id-value="<%= @project.id %>">
  <%# Header with stats %>
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold flex items-center gap-2">
        <%= render Ui::IconComponent.new(name: :clipboard_document_list, size: :md) %>
        Team Board
      </h1>
      <p class="text-base-content/60 mt-1">
        <%= @project.name %> &mdash; <%= @stats[:total] %> tasks
      </p>
    </div>

    <div class="flex items-center gap-2">
      <%# Filter by scope %>
      <select class="select select-bordered select-sm"
              data-action="change->team-board#filterByScope">
        <option value="">All Scopes</option>
        <option value="global" <%= "selected" if params[:scope] == "global" %>>Global</option>
        <option value="session" <%= "selected" if params[:scope] == "session" %>>Session</option>
      </select>

      <%# Connection status indicator %>
      <div class="badge badge-outline gap-1" data-team-board-target="connectionStatus">
        <span class="loading loading-dots loading-xs"></span>
        Connecting...
      </div>
    </div>
  </div>

  <%# Progress bar and stats %>
  <div class="mb-6">
    <%# Overall progress %>
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium">Overall Progress</span>
        <span class="text-sm text-base-content/60"><%= @progress %>% complete</span>
      </div>
      <progress class="progress progress-success w-full h-3"
                value="<%= @progress %>"
                max="100"
                role="progressbar"
                aria-valuenow="<%= @progress %>"
                aria-valuemin="0"
                aria-valuemax="100"></progress>
    </div>

    <%# Stats bar %>
    <div class="stats stats-horizontal shadow w-full">
      <div class="stat py-2 px-4">
        <div class="stat-title text-xs">Pending</div>
        <div class="stat-value text-lg text-warning"><%= @stats[:pending] %></div>
      </div>
      <div class="stat py-2 px-4">
        <div class="stat-title text-xs">In Progress</div>
        <div class="stat-value text-lg text-info"><%= @stats[:in_progress] %></div>
      </div>
      <div class="stat py-2 px-4">
        <div class="stat-title text-xs">Blocked</div>
        <div class="stat-value text-lg text-error"><%= @stats[:blocked] %></div>
      </div>
      <div class="stat py-2 px-4">
        <div class="stat-title text-xs">Completed</div>
        <div class="stat-value text-lg text-success"><%= @stats[:completed] %></div>
      </div>
    </div>
  </div>

  <%# Active Agents Panel %>
  <% if @active_agents.any? %>
    <div class="mb-6 bg-base-200 rounded-lg p-4">
      <h3 class="font-semibold flex items-center gap-2 mb-3">
        <%= render Ui::IconComponent.new(name: :cpu_chip, size: :sm) %>
        Active Agents
        <span class="badge badge-primary badge-sm"><%= @active_agents.count %></span>
      </h3>
      <div class="flex flex-wrap gap-3">
        <% @active_agents.each do |agent| %>
          <div class="flex items-center gap-2 bg-base-100 rounded-lg px-3 py-2 shadow-sm">
            <div class="relative">
              <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
                <%= render Ui::IconComponent.new(name: :command_line, size: :sm, css_class: "text-primary") %>
              </div>
              <% if agent.active? %>
                <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-success rounded-full border-2 border-base-100 animate-pulse"></span>
              <% elsif agent.idle? %>
                <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-warning rounded-full border-2 border-base-100"></span>
              <% end %>
            </div>
            <div class="min-w-0">
              <div class="font-medium text-sm truncate max-w-24">
                <%= agent.display_name %>
              </div>
              <div class="text-xs text-base-content/60">
                <%= agent.agent_type.humanize %> &middot;
                <% if agent.last_heartbeat_at %>
                  <%= time_ago_in_words(agent.last_heartbeat_at) %> ago
                <% else %>
                  Just connected
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Kanban columns %>
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
    <%# Pending column %>
    <div class="bg-base-200 rounded-lg p-4" id="column-pending">
      <h3 class="font-semibold text-warning flex items-center gap-2 mb-4">
        <%= render Ui::IconComponent.new(name: :clock, size: :sm) %>
        Pending
        <span class="badge badge-warning badge-sm"><%= @stats[:pending] %></span>
      </h3>
      <div class="space-y-3" data-team-board-target="pendingColumn">
        <% @tasks_by_status[:pending].each do |task| %>
          <%= render "task_card", task: %>
        <% end %>
        <% if @tasks_by_status[:pending].empty? %>
          <p class="text-base-content/40 text-sm text-center py-4">No pending tasks</p>
        <% end %>
      </div>
    </div>

    <%# In Progress column %>
    <div class="bg-base-200 rounded-lg p-4" id="column-in_progress">
      <h3 class="font-semibold text-info flex items-center gap-2 mb-4">
        <%= render Ui::IconComponent.new(name: :play, size: :sm) %>
        In Progress
        <span class="badge badge-info badge-sm"><%= @stats[:in_progress] %></span>
      </h3>
      <div class="space-y-3" data-team-board-target="inProgressColumn">
        <% @tasks_by_status[:in_progress].each do |task| %>
          <%= render "task_card", task: %>
        <% end %>
        <% if @tasks_by_status[:in_progress].empty? %>
          <p class="text-base-content/40 text-sm text-center py-4">No tasks in progress</p>
        <% end %>
      </div>
    </div>

    <%# Blocked column %>
    <div class="bg-base-200 rounded-lg p-4" id="column-blocked">
      <h3 class="font-semibold text-error flex items-center gap-2 mb-4">
        <%= render Ui::IconComponent.new(name: :exclamation_triangle, size: :sm) %>
        Blocked
        <span class="badge badge-error badge-sm"><%= @stats[:blocked] %></span>
      </h3>
      <div class="space-y-3" data-team-board-target="blockedColumn">
        <% @tasks_by_status[:blocked].each do |task| %>
          <%= render "task_card", task: %>
        <% end %>
        <% if @tasks_by_status[:blocked].empty? %>
          <p class="text-base-content/40 text-sm text-center py-4">No blocked tasks</p>
        <% end %>
      </div>
    </div>

    <%# Completed column %>
    <div class="bg-base-200 rounded-lg p-4" id="column-completed">
      <h3 class="font-semibold text-success flex items-center gap-2 mb-4">
        <%= render Ui::IconComponent.new(name: :check_circle, size: :sm) %>
        Completed
        <span class="badge badge-success badge-sm"><%= @stats[:completed] %></span>
      </h3>
      <div class="space-y-3" data-team-board-target="completedColumn">
        <% @tasks_by_status[:completed].each do |task| %>
          <%= render "task_card", task: %>
        <% end %>
        <% if @tasks_by_status[:completed].empty? %>
          <p class="text-base-content/40 text-sm text-center py-4">No completed tasks</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# Task detail modal %>
<dialog id="task_detail_modal" class="modal" data-team-board-target="modal">
  <div class="modal-box max-w-2xl" data-team-board-target="modalContent">
    <%# Content loaded dynamically %>
    <div class="flex items-center justify-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<%# Toast container for notifications %>
<div class="toast toast-top toast-end z-[10000]">
  <%# Toasts will be appended here by JavaScript %>
</div>
