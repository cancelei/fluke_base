<% if Rails.env.production? && RailsCloudflareTurnstile.configuration.enabled && Rails.application.config.turnstile[:site_key].present? %>
  <!-- Cloudflare Turnstile widget -->
  <div class="cf-turnstile"
       data-sitekey="<%= Rails.application.config.turnstile[:site_key] %>"
       data-callback="onTurnstileSuccess"
       data-error-callback="onTurnstileError"
       data-expired-callback="onTurnstileExpired"
       data-size="normal"
       data-theme="auto"
       data-tabindex="0">
  </div>

  <!-- Hidden input for the response -->
  <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response">

  <script nonce="<%= content_security_policy_nonce %>">
    // Helper to find the closest form containing the turnstile widget
    function findTurnstileForm() {
      const turnstileWidget = document.querySelector('.cf-turnstile');
      return turnstileWidget?.closest('form');
    }

    window.onTurnstileSuccess = function(token) {
      // Set the token in the hidden input
      const responseInput = document.getElementById('cf-turnstile-response');
      if (responseInput) {
        responseInput.value = token;
      }

      // Enable the submit button in the containing form
      const form = findTurnstileForm();
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    window.onTurnstileError = function(error) {
      console.error('Turnstile verification error:', error);

      // Clear the token on error
      const responseInput = document.getElementById('cf-turnstile-response');
      if (responseInput) {
        responseInput.value = '';
      }

      // Disable form submission on error
      const form = findTurnstileForm();
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    window.onTurnstileExpired = function() {
      // Clear the token on expiration
      const responseInput = document.getElementById('cf-turnstile-response');
      if (responseInput) {
        responseInput.value = '';
      }

      // Disable form submission when token expires
      const form = findTurnstileForm();
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    // Initialize: disable submit button until Turnstile verification completes
    document.addEventListener('DOMContentLoaded', function() {
      const form = findTurnstileForm();
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      // Fallback: If Turnstile doesn't initialize within 5 seconds, enable the button anyway
      // This prevents users from being locked out if Turnstile fails to load
      setTimeout(function() {
        const responseInput = document.getElementById('cf-turnstile-response');
        const turnstileContainer = document.querySelector('.cf-turnstile');
        // Only enable if Turnstile hasn't already succeeded
        if (!responseInput || !responseInput.value) {
          const fallbackForm = findTurnstileForm();
          if (fallbackForm) {
            const btn = fallbackForm.querySelector('input[type="submit"]');
            if (btn && btn.disabled) {
              console.warn('Turnstile failed to initialize. Enabling form submission as fallback.');
              btn.disabled = false;
              btn.classList.remove('opacity-50', 'cursor-not-allowed');

              // Show a message to the user
              if (turnstileContainer) {
                turnstileContainer.innerHTML = '<div class="text-sm text-warning bg-warning/10 p-3 rounded-md">Security check unavailable. You can still submit the form.</div>';
              }
            }
          }
        }
      }, 5000);
    });
  </script>
<% elsif Rails.env.development? %>
  <div class="text-sm text-info bg-info/10 p-3 rounded-md">
    Turnstile is disabled in development for easier local testing.
  </div>
<% else %>
  <div class="text-sm text-warning bg-warning/10 p-3 rounded-md">
    Turnstile is not configured. Please set TURNSTILE_SITE_KEY environment variable.
  </div>
<% end %>
