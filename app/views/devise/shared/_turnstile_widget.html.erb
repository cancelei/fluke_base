<% if Rails.application.config.turnstile[:site_key].present? %>
  <div class="turnstile-widget" data-sitekey="<%= Rails.application.config.turnstile[:site_key] %>" data-callback="onTurnstileSuccess" data-expired-callback="onTurnstileExpired" data-error-callback="onTurnstileError" data-size="invisible"></div>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <script>
    function onTurnstileSuccess(token) {
      // Add the token to the form as a hidden field
      const form = document.querySelector('form');
      if (form) {
        // Remove any existing turnstile token field
        const existingTokenField = form.querySelector('input[name="turnstile_token"]');
        if (existingTokenField) {
          existingTokenField.remove();
        }

        // Add the new token field
        const tokenField = document.createElement('input');
        tokenField.type = 'hidden';
        tokenField.name = 'turnstile_token';
        tokenField.value = token;
        form.appendChild(tokenField);
      }
    }

    function onTurnstileExpired() {
      // Handle expired token
      console.log('Turnstile token expired');
    }

    function onTurnstileError(error) {
      // Handle error
      console.error('Turnstile error:', error);
    }
  </script>
<% else %>
  <div class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-md">
    ⚠️ Turnstile is not configured. Please set TURNSTILE_SITE_KEY environment variable.
  </div>
<% end %>
