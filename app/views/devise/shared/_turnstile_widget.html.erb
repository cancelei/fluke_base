<% if Rails.env.development? %>
  <div class="text-sm text-blue-600 bg-blue-50 p-3 rounded-md">
    üîß Development Mode: Turnstile verification is disabled for easier testing.
  </div>
<% elsif Rails.application.config.turnstile[:site_key].present? %>
  <div class="text-sm text-green-600 bg-green-50 p-3 rounded-md">
    üõ°Ô∏è Security verification enabled (invisible)
  </div>

  <!-- Cloudflare Turnstile widget in invisible mode -->
  <%= cloudflare_turnstile(
    size: "invisible",
    theme: "auto",
    tabindex: 0,
    response_field_name: "cf-turnstile-response",
    data: {
      callback: "onTurnstileSuccess",
      "error-callback": "onTurnstileError",
      "expired-callback": "onTurnstileExpired"
    }
  ) %>

  <script nonce="<%= content_security_policy_nonce %>">
    window.onTurnstileSuccess = function(token) {
      console.log('Turnstile challenge passed:', token);
      // Find the form containing the turnstile widget and enable submission
      const form = document.querySelector('form[action*="sign_in"]');
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    window.onTurnstileError = function(error) {
      console.error('Turnstile error:', error);
      // Show user-friendly error message
      const form = document.querySelector('form[action*="sign_in"]');
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    window.onTurnstileExpired = function() {
      console.warn('Turnstile token expired');
      // Reset form state when token expires
      const form = document.querySelector('form[action*="sign_in"]');
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    };

    // Initialize form state on page load
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form[action*="sign_in"]');
      if (form) {
        const submitButton = form.querySelector('input[type="submit"]');
        if (submitButton) {
          // Disable submit button until Turnstile verification completes
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    });
  </script>
<% else %>
  <div class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-md">
    ‚ö†Ô∏è Turnstile is not configured. Please set TURNSTILE_SITE_KEY environment variable.
  </div>
<% end %>
