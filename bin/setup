#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

def log(message, color: :none)
  colors = {
    green: "\e[32m",
    yellow: "\e[33m",
    red: "\e[31m",
    blue: "\e[34m",
    none: ""
  }
  reset = "\e[0m"

  puts "#{colors[color]}#{message}#{reset}"
end

def check_ruby_version
  required_version = File.read(".ruby-version").strip
  current_version = RUBY_VERSION

  log "Checking Ruby version...", color: :blue
  if current_version != required_version
    log "⚠️  Warning: Ruby version mismatch", color: :yellow
    log "   Required: #{required_version}", color: :yellow
    log "   Current:  #{current_version}", color: :yellow

    unless ENV["SKIP_RUBY_CHECK"]
      log "   Run with SKIP_RUBY_CHECK=1 to bypass this check", color: :yellow
      exit 1
    end
  else
    log "✓ Ruby #{current_version}", color: :green
  end
end

def check_node_version
  required_version = File.read(".node-version").strip
  current_version = `node --version 2>/dev/null`.strip.sub(/^v/, "")

  log "Checking Node.js version...", color: :blue
  if current_version.empty?
    log "⚠️  Warning: Node.js not found", color: :yellow
    log "   Required: #{required_version}", color: :yellow
    log "   Install Node.js from https://nodejs.org", color: :yellow
    exit 1 unless ENV["SKIP_NODE_CHECK"]
  elsif !current_version.start_with?(required_version.split(".").first)
    log "⚠️  Warning: Node.js version mismatch", color: :yellow
    log "   Required: #{required_version}", color: :yellow
    log "   Current:  #{current_version}", color: :yellow
  else
    log "✓ Node.js #{current_version}", color: :green
  end
end

def check_postgres
  log "Checking PostgreSQL availability...", color: :blue

  # Try to connect to PostgreSQL using pg_isready (if available) or psql
  pg_ready = system("pg_isready -q 2>/dev/null")

  unless pg_ready
    # Fallback: try psql connection test
    pg_ready = system("psql -c 'SELECT 1' postgres > /dev/null 2>&1")
  end

  if pg_ready
    log "✓ PostgreSQL is running", color: :green
    true
  else
    log "✗ PostgreSQL is not available", color: :red
    log "  Please start PostgreSQL before running setup:", color: :yellow
    log "    macOS:   brew services start postgresql", color: :yellow
    log "    Linux:   sudo systemctl start postgresql", color: :yellow
    log "    Docker:  docker-compose up -d postgres", color: :yellow
    log "", color: :none
    log "  Or set SKIP_DB_CHECK=1 to bypass this check", color: :yellow

    if ENV["SKIP_DB_CHECK"]
      log "  (Bypassing PostgreSQL check due to SKIP_DB_CHECK)", color: :yellow
      true
    else
      false
    end
  end
end

FileUtils.chdir APP_ROOT do
  log "== Setting up Fluke Base ==\n", color: :blue

  # Check versions
  check_ruby_version
  check_node_version

  puts
  log "== Installing dependencies ==", color: :blue
  system("bundle check") || system!("bundle install")
  system!("npm install") if File.exist?("package.json")

  # Check PostgreSQL before database operations
  puts
  unless check_postgres
    log "Setup aborted: PostgreSQL is required", color: :red
    exit 1
  end

  puts
  log "== Preparing database ==", color: :blue
  system! "bin/rails db:prepare"

  puts
  log "== Seeding database ==", color: :blue
  system! "bin/rails db:seed"

  puts
  log "== Removing old logs and tempfiles ==", color: :blue
  system! "bin/rails log:clear tmp:clear"

  puts
  log "✓ Setup complete!", color: :green

  # Server start is opt-in (use --start flag)
  # This makes bin/setup CI-friendly by default
  if ARGV.include?("--start")
    puts
    log "== Starting development server ==", color: :blue
    STDOUT.flush
    exec "bin/dev"
  else
    log "  Run 'bin/dev' to start the development server", color: :blue
    log "  Or run 'bin/setup --start' to setup and start in one command", color: :blue
  end
end
